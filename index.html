<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <title>Memory Palace 3D - Method of Loci</title>
        <link rel="stylesheet" href="css/styles.css" />
        <style>
            /* Memory Palace specific inline styles */
            #loading-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                transition: opacity 0.5s ease-out;
            }

            #loading-screen.hidden {
                opacity: 0;
                pointer-events: none;
            }

            .loading-content {
                text-align: center;
                color: #ffffff;
            }

            .loading-content h1 {
                font-size: 48px;
                margin-bottom: 20px;
                color: #4a9eff;
                text-shadow: 0 0 20px rgba(74, 158, 255, 0.5);
            }

            .loading-content p {
                font-size: 18px;
                color: #aaa;
                margin-bottom: 30px;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 5px solid #333;
                border-top-color: #4a9eff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Hidden textarea for text input capture */
            #textInput {
                position: absolute;
                left: -9999px;
                top: -9999px;
                width: 1px;
                height: 1px;
                opacity: 0;
                pointer-events: none;
                z-index: -1;
            }

            /* Cursor locked state */
            body.cursor-locked {
                cursor: none;
            }

            /* Prevent text selection during gameplay */
            body.playing {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }
        </style>
    </head>
    <body>
        <!-- Loading Screen -->
        <div id="loading-screen">
            <div class="loading-content">
                <h1>ğŸ›ï¸ Memory Palace 3D</h1>
                <p>Loading your spatial memory environment...</p>
                <div class="spinner"></div>
                <p id="loading-status" style="font-size: 14px; color: #666; margin-top: 20px;">Initializing...</p>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="appContainer">
            <div id="UIControlsContainer"></div>
        </div>

        <!-- Hidden textarea for text input capture -->
        <textarea id="textInput" aria-hidden="true" tabindex="-1"></textarea>

        <!-- 3rd party libs -->
        <!-- sf2-player https://github.com/JanVeb/sf2-player -->
        <script src="lib/sf2-player/parser.js"></script>
        <script src="lib/sf2-player/riff.js"></script>
        <script src="lib/sf2-player/reverb.js"></script>
        <script src="lib/sf2-player/sound_font_synth_note.js"></script>
        <script src="lib/sf2-player/sound_font_synth.js"></script>
        <script src="lib/sf2-player/sf2-player.js"></script>
        <script src="lib/sf2-player/soundfont/soundfont.js"></script>

        # Goblin fork of https://github.com/chandlerprall/GoblinPhysics # https://github.com/Tomobobo710/GoblinPhysics
        <script src="lib/goblin/goblin.js"></script>

        ####Action Engine Modules#### 
        
        # Action Engine Math
        <script src="actionengine/math/geometry/triangle.js"></script>
        <script src="actionengine/math/geometry/triangleutils.js"></script>
        <script src="actionengine/math/geometry/geometrybuilder.js"></script>
        <script src="actionengine/math/geometry/glbloader.js"></script>
		<script src="actionengine/math/geometry/glbexporter.js"></script>
		<script src="actionengine/math/geometry/modelcodegenerator.js"></script>
        <script src="actionengine/math/vector2.js"></script>
        <script src="actionengine/math/vector3.js"></script>
        <script src="actionengine/math/matrix4.js"></script>
        <script src="actionengine/math/quaternion.js"></script>
        <script src="actionengine/math/mathutils.js"></script>
        <script src="actionengine/math/viewfrustum.js"></script>

        # Action Engine Rendering (Triangles)
        <!-- Rendererable Object -->
        <script src="actionengine/display/graphics/renderableobject.js"></script>
        
        <!-- 3D Model -->
        <script src="actionengine/display/graphics/actionmodel3D.js"></script>
		<script src="actionengine/display/graphics/actionsprite3D.js"></script>
        
        <!-- 2D Software Renderer -->
        <script src="actionengine/display/graphics/renderers/actionrenderer2D.js"></script>

        <!-- 3D WebGL Renderer -->
        <script src="actionengine/display/graphics/renderers/actionrenderer3D/actionrenderer3D.js"></script>
        <script src="actionengine/display/graphics/renderers/actionrenderer3D/objectrenderer3D.js"></script>
        <script src="actionengine/display/graphics/renderers/actionrenderer3D/weatherrenderer3D.js"></script>
		<script src="actionengine/display/graphics/renderers/actionrenderer3D/waterrenderer3D.js"></script>
		<script src="actionengine/display/graphics/renderers/actionrenderer3D/sunrenderer3D.js"></script>
		<script src="actionengine/display/graphics/renderers/actionrenderer3D/spriterenderer3D.js"></script>
        <script src="actionengine/display/graphics/renderers/actionrenderer3D/debugrenderer3D.js"></script>
        <script src="actionengine/display/graphics/renderers/actionrenderer3D/canvasmanager3D.js"></script>
		
		# Action Engine Lighting
        <script src="actionengine/display/graphics/lighting/lightingconstants.js"></script>
        <script src="actionengine/display/graphics/lighting/actionlight.js"></script>
        <script src="actionengine/display/graphics/lighting/actiondirectionalshadowlight.js"></script>
        <script src="actionengine/display/graphics/lighting/actionomnidirectionalshadowlight.js"></script>
        <script src="actionengine/display/graphics/lighting/lightmanager.js"></script>
		
		# Action Engine Debug
		<script src="actionengine/debug/basedebugpanel.js"></script>
		
        # Image Texture System
        <script src="actionengine/display/graphics/texture/proceduraltexture.js"></script>
        <script src="actionengine/display/graphics/texture/texturemanager.js"></script>
        <script src="actionengine/display/graphics/texture/textureregistry.js"></script>
		
        # GL Shader Management
        <!-- Core shader management -->
        <script src="actionengine/display/gl/programmanager.js"></script>

        <!-- Action Engine shader implementations -->
        <script src="actionengine/display/gl/shaders/objectshader.js"></script>
        <script src="actionengine/display/gl/shaders/lineshader.js"></script>
		<script src="actionengine/display/gl/shaders/spriteshader.js"></script>
        <script src="actionengine/display/gl/shaders/shadowshader.js"></script>
        <script src="actionengine/display/gl/shaders/watershader.js"></script>
        <script src="actionengine/display/gl/shaders/particleshader.js"></script>
        
		# Action Engine Physics (goblin)
        <script src="actionengine/math/physics/actionphysicsworld3D.js"></script>
        <script src="actionengine/math/physics/actionphysicsobject3D.js"></script>
        <script src="actionengine/math/physics/shapes/actionphysicsplane3D.js"></script>
        <script src="actionengine/math/physics/shapes/actionphysicsbox3D.js"></script>
        <script src="actionengine/math/physics/shapes/actionphysicssphere3D.js"></script>
		<script src="actionengine/math/physics/shapes/actionphysicscapsule3D.js"></script>
		<script src="actionengine/math/physics/shapes/actionphysicscone3D.js"></script>
		<script src="actionengine/math/physics/shapes/actionphysicscylinder3D.js"></script>
		<script src="actionengine/math/physics/shapes/actionphysicscompoundshape3D.js"></script>
		<script src="actionengine/math/physics/shapes/actionphysicsconvexshape3D.js"></script>
		<script src="actionengine/math/physics/shapes/actionphysicsmesh3D.js"></script>
		<script src="actionengine/math/physics/actionraycast.js"></script>
        <script src="actionengine/math/physics/actionphysics.js"></script>

        # Action Engine Sound
        <!-- <script src="actionengine/sound/audiomanager.js"></script> -->

        # Action Engine Input
        <!-- <script src="actionengine/input/inputhandler.js"></script> -->

        # Action Engine Camera
        <script src="actionengine/camera/actioncamera.js"></script>
  <script src="actionengine/camera/cameracollisionhandler.js"></script>

        # Action Engine 3-Layer Canvas System
        <!-- <script src="actionengine/display/canvasmanager.js"></script> -->

  # Action Engine Character Controller
  <script src="actionengine/character/actioncharacter.js"></script>
  <script src="actionengine/character/actioncharacter3D.js"></script>

        # Action Engine Bootstrap
        <!-- <script type="module" src="actionengine/core/app.js"></script> -->
        #############################
        
        ####Game Specific Modules####
        <!-- Memory Palace API Client -->
        <script type="module" src="api.js"></script>
        #############################

        <script type="module">
            import { App } from './actionengine/core/app.js'; // Import App class
            import { MemoryPalaceAPI } from './api.js'; // Import MemoryPalaceAPI
            import { Game } from './game.js'; // Import Game class - Keep this import

            // Memory Palace 3D Initialization Script
            console.log('ğŸ›ï¸ Memory Palace 3D - Starting initialization...');

            let loadingStatus = document.getElementById('loading-status');

            function updateLoadingStatus(message) {
                if (loadingStatus) {
                    loadingStatus.textContent = message;
                }
                console.log('ğŸ“Š', message);
            }

            // Wait for all scripts to load
            window.addEventListener('load', async () => {
                try {
                    updateLoadingStatus('Checking ActionEngine...');

                    // Verify ActionEngine is loaded
                    // if (typeof App === 'undefined') { // No longer needed with module import
                    //     throw new Error('ActionEngine App not found. Ensure actionengine/core/app.js is loaded.');
                    // }
                    // console.log('âœ… ActionEngine loaded successfully'); // No longer needed
                    updateLoadingStatus('ActionEngine loaded');

                    // Check backend connection
                    let backendAvailable = false;
                    updateLoadingStatus('Connecting to server...');

                    try {
                        // if (typeof MemoryPalaceAPI !== 'undefined') { // No longer needed with module import
                            const health = await MemoryPalaceAPI.healthCheck(); // Call healthCheck on the imported module
                            backendAvailable = true;
                            console.log('âœ… Backend connected:', health);
                            updateLoadingStatus('Server connected');
                        // } else { // No longer needed
                        //     throw new Error('API client not loaded');
                        // }
                    } catch (error) {
                        console.warn('âš ï¸ Backend not available:', error.message);
                        console.warn('ğŸ“¦ Using localStorage only');
                        updateLoadingStatus('Offline mode - using local storage');
                        backendAvailable = false;
                    }

                    // Store backend availability globally
                    window.BACKEND_AVAILABLE = backendAvailable;

                    updateLoadingStatus('Initializing game...');

                    // Give the game a moment to initialize
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Hide loading screen
                    updateLoadingStatus('Ready!');
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.classList.add('hidden');
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                            }, 500);
                        }

                        // Add playing class to body
                        document.body.classList.add('playing');

                        // The App class handles its own canvas, input, and audio initialization.
                        // We just need to instantiate it and pass the Game class.
                        // The game instance is now accessible via window.game.game
                        // (App creates game, App is assigned to window.game)
                        window.game = new App({}, Game, backendAvailable);

                    }, 800);

                    console.log('âœ… Memory Palace 3D initialized successfully');

                } catch (error) {
                    console.error('âŒ Initialization error:', error);

                    // Show error to user
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        const content = loadingScreen.querySelector('.loading-content');
                        content.innerHTML = `
                            <h1 style="color: #ff4444;">âš ï¸ Initialization Error</h1>
                            <p>Failed to initialize Memory Palace 3D</p>
                            <p style="font-size: 14px; color: #ff6666; max-width: 500px; margin: 20px auto;">${error.message}</p>
                            <button onclick="location.reload()" style="
                                margin-top: 20px;
                                padding: 12px 24px;
                                background: #4a9eff;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: bold;
                                transition: background 0.3s;
                            " onmouseover="this.style.background='#3a8eef'" onmouseout="this.style.background='#4a9eff'">
                                ğŸ”„ Reload Page
                            </button>
                            <p style="font-size: 12px; color: #666; margin-top: 20px;">
                                Make sure the backend server is running:<br>
                                <code style="background: #222; padding: 5px 10px; border-radius: 3px; display: inline-block; margin-top: 10px;">npm start</code>
                            </p>
                        `;
                    }
                }
            });

            // Handle pointer lock for mouse control
            document.addEventListener('pointerlockchange', () => {
                if (document.pointerLockElement) {
                    document.body.classList.add('cursor-locked');
                    console.log('ğŸ”’ Pointer locked');
                } else {
                    document.body.classList.remove('cursor-locked');
                    console.log('ğŸ”“ Pointer unlocked');
                }
            });

            // Prevent context menu on canvas
            document.addEventListener('contextmenu', (e) => {
                const target = e.target;
                if (target.tagName === 'CANVAS') {
                    e.preventDefault();
                }
            });

            // Handle visibility change (pause when tab is hidden)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('ğŸ”‡ Tab hidden - game may pause');
                } else {
                    console.log('ğŸ”Š Tab visible - game resumed');
                }
            });

            // Global error handling
            window.addEventListener('error', (e) => {
                console.error('ğŸ’¥ Runtime error:', e.error);
            });

            window.addEventListener('unhandledrejection', (e) => {
                console.error('ğŸ’¥ Unhandled promise rejection:', e.reason);
            });

            // Keyboard shortcuts info
            console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ›ï¸  Memory Palace 3D - Controls                 â•‘
â•‘                                                    â•‘
â•‘   Movement:                                        â•‘
â•‘   â€¢ WASD - Move around                            â•‘
â•‘   â€¢ Mouse - Look around                           â•‘
â•‘   â€¢ Space - Jump / Fly up                         â•‘
â•‘   â€¢ Shift - Sprint / Fly down                     â•‘
â•‘   â€¢ F - Toggle flying mode                        â•‘
â•‘                                                    â•‘
â•‘   Actions:                                         â•‘
â•‘   â€¢ Left Click - Place block                      â•‘
â•‘   â€¢ Right Click - Edit block text                 â•‘
â•‘   â€¢ Delete Key - Delete hovered block             â•‘
â•‘                                                    â•‘
â•‘   System:                                          â•‘
â•‘   â€¢ Ctrl+S - Save                                 â•‘
â•‘   â€¢ Ctrl+L - Load                                 â•‘
â•‘   â€¢ Escape - Release mouse                        â•‘
â•‘                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `);
        </script>
    </body>
</html>